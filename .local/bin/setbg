#!/bin/dash
# Sets the background. If given a file, set that as the new wallpaper.
# Supports the following wallpaper setters: feh, xwallpaper.

bg="${XDG_CONFIG_HOME:-$HOME/.config/}/bg"
img=${1:-}

for setter in feh xwallpaper; do
    command -v $setter >/dev/null && break
done

if [ -e "$img" ]; then
    # set a new wallpaper
    img=$(readlink -f "$img")
    case "$(file --mime-type -b "$img")" in
        image/*)
            r="" && ln --version 2>/dev/null | grep -qi gnu && r="-r"
            ln -sf $r "$img" "$bg" ;;
        *)
            echo "$(basename "$0"): '$img' is not a valid image" 1>&2
            exit 1 ;;
    esac
elif [ "$img" = '--solid' ]; then
    # set a solid background color (e.g. setbg --solid "#000000")
    tmp="$(mktemp ${XDG_RUNTIME_DIR:-${TMPDIR:-/tmp}}/XXXXXXXXXX.xpm)"
    printf "/* XPM */\nstatic char * xpm[] = {\n\"2 1 1 1\",\n\". c $2\",\n\"..\"\n};\n" >> "$tmp"
    case $setter in
        feh) feh --no-fehbg --bg-fill "$tmp" ;;
        xwallpaper) xwallpaper --tile "$tmp" ;;
    esac
    rm -f "$tmp"
    exit
elif [ -n "$img" ]; then
    echo "$(basename "$0"): '$img' does not exists" 1>&2
    exit 1
fi

case $setter in
    feh) feh --no-fehbg --bg-fill "$bg" ;;
    xwallpaper) xwallpaper --zoom "$bg" ;;
esac
